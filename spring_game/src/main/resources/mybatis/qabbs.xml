<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="qabbs">
	
	<insert id="create" parameterType="QabbsDTO">
		insert into qabbs(qano, nicname, category, subject, content, passwd, qadate, grpno)
		values((select nvl(max(qano),0)+1 as qano from qabbs), #{nicname}, #{category}, 
		#{subject}, #{content}, #{passwd}, sysdate,
		(select nvl(max(grpno),0)+1 as grpno from qabbs) )
	</insert>
	
	<select id="read" parameterType="int" resultType="QabbsDTO">
		select qano, nicname, category, subject, content, passwd, qadate, viewcount,
		grpno, indent, ansnum, refnum 
		from qabbs
		where qano = #{qano}
	</select>
	
	<update id="update" parameterType="QabbsDTO">
		update qabbs 
		set category = #{category},
		    subject = #{subject},
		    content = #{content}
		where qano = #{qano}	
	</update>
	
	<delete id="delete" parameterType="int">
	 	delete from qabbs where qano = #{qano}
	</delete>

	<select id="list" parameterType="Map" resultType="QabbsDTO">
		select qano, nicname, category, subject, content, qadate, viewcount, r
		from(
			select qano, nicname, category, subject, content, qadate, viewcount,
			rownum as r
			from(
				select qano, nicname, category, subject, content, qadate, viewcount
				from qabbs		
				order by grpno desc, ansnum
				<where>
					<choose>
						<when test="col=='category'">
	           				category like '%'||#{word}||'%'
	           			</when>
					    <when test="col=='subject'">
	           	 			subject like '%'||#{word}||'%'
	            		</when>
	            		<when test="col=='content'">
	           				content like '%'||#{word}||'%'
	            		</when>        
	           		</choose>      
           		</where>             
				)
			)      
	<![CDATA[                                                                        
   where r>=#{sno} and r<=#{eno}
   ]]>   
	</select>
	
	<select id="total" parameterType="Map" resultType="int">
	select count(*) from qabbs
		<where>
		<choose>
			<when test="col=='category'">
         		category like '%'||#{word}||'%'
         	</when>
		    <when test="col=='subject'">
         	 	subject like '%'||#{word}||'%'
      		</when>
      		<when test="col=='content'">
     			content like '%'||#{word}||'%'
      		</when>        
        </choose>      
        </where>  	
	</select>
	
	<update id="upViewcount" parameterType="int">
		update qabbs         
		set viewcount = viewcount + 1
		where qano=#{qano}
	</update>
	
	<select id="passCheck" parameterType="Map" resultType="int">
		select count(qano) as cnt
		from qabbs                 
			where qano= #{qano}       
			and passwd= #{passwd}             
	</select>
	
	<insert id="replyCreate" parameterType="QabbsDTO">
		insert into qabbs(qano, nicname, category, subject, content, passwd, qadate, grpno, indent, ansnum, refnum )
		values((select nvl(max(qano),0)+1 as qano from qabbs), #{nicname}, #{category}, 
		#{subject}, #{content}, #{passwd}, sysdate,
		#{grpno},#{indent}+1,#{ansnum}+1,#{qano})	
	</insert>
	
	<select id="replyRead" parameterType="int" resultType="QabbsDTO">
		select qano,subject,grpno,indent,ansnum 
			from qabbs                                
		where qano=#{qano}                         
	</select>
	
	<update id="upAnsnum" parameterType="Map">
		update qabbs               
		set ansnum = ansnum + 1
			where grpno = #{grpno}         
			and ansnum > #{ansnum}         
	</update>
	
	<select id="checkRefnum" parameterType="int" resultType="int">
		select count(*) from qabbs
		where refnum = #{qano}
	</select>
	
</mapper>